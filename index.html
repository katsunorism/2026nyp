// スプレッドシート内の各シート名を定義
const SS = SpreadsheetApp.getActiveSpreadsheet();
const FORM_SHEET = SS.getSheetByName("フォームの回答 1"); // 申込データ
const MASTER_SHEET = SS.getSheetByName("精算確認シート"); // 精算管理用

function doGet(e) {
  const action = e.parameter.action;
  
  // データの読み込み
  const data = MASTER_SHEET.getDataRange().getValues();
  const headers = data.shift(); // ヘッダーを削除
  
  // A列:名前, B列:飲み放題, F列:ステータス を取得
  const users = data.map(row => ({
    name: row[0],
    isUnlimited: (row[1] === "有" || row[1] === true),
    status: row[5]
  })).filter(u => u.name); // 空行を除外

  if (action === "getData") {
    return ContentService.createTextOutput(JSON.stringify(users))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  let params;
  try {
    params = JSON.parse(e.postData.contents);
  } catch (err) {
    return ContentService.createTextOutput("Error: Invalid JSON").setMimeType(ContentService.MimeType.TEXT);
  }
  
  const action = params.action;
  const targetName = params.name;

  if (action === "submit") {
    // 1. 注文内容の書き込み（精算確認シートの C:注文詳細, D:ドリンク合計）
    const data = MASTER_SHEET.getDataRange().getValues();
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === targetName) {
        const row = i + 1;
        MASTER_SHEET.getRange(row, 3).setValue(params.details); // C列: 注文詳細
        MASTER_SHEET.getRange(row, 4).setValue(params.total);   // D列: ドリンク合計
        MASTER_SHEET.getRange(row, 7).setValue(new Date());     // G列: 更新日時
        break;
      }
    }
    return ContentService.createTextOutput("Success");
  }

  if (action === "complete") {
    // 2. 精算完了ステータスの更新（F列）
    const data = MASTER_SHEET.getDataRange().getValues();
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === targetName) {
        const row = i + 1;
        MASTER_SHEET.getRange(row, 6).setValue("精算完了"); // F列: ステータス
        MASTER_SHEET.getRange(row, 7).setValue(new Date()); // G列: 更新日時
        break;
      }
    }
    return ContentService.createTextOutput("Success");
  }
}
