const SHEET_NAME = '精算確認シート'; 

function doGet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME);
  const lastRow = sheet.getLastRow();
  
  if (lastRow <= 1) return ContentService.createTextOutput("[]").setMimeType(ContentService.MimeType.JSON);
  
  // A列(名前), B列(飲み放題), F列(ステータス)を取得
  const data = sheet.getRange(2, 1, lastRow - 1, 6).getValues();
  const userMaster = data.map(row => ({
    name: row[0],
    isUnlimited: row[1] === "有", 
    status: row[5] || "" // F列がステータス
  }));

  return ContentService.createTextOutput(JSON.stringify(userMaster))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(SHEET_NAME);
    const values = sheet.getDataRange().getValues();
    let rowIndex = -1;
    let currentStatus = "";

    for (let i = 0; i < values.length; i++) {
      if (values[i][0] === data.name) {
        rowIndex = i + 1;
        currentStatus = values[i][5]; 
        break;
      }
    }

    if (currentStatus === "精算完了") {
      return ContentService.createTextOutput("Error: Already Settled");
    }

    if (data.action === "complete") {
      if (rowIndex !== -1) {
        if (data.isUnlimited) {
          sheet.getRange(rowIndex, 3, 1, 4).setValues([["飲み放題プラン", 11500, 11500, "精算完了"]]);
        } else {
          sheet.getRange(rowIndex, 6).setValue("精算完了");
        }
        sheet.getRange(rowIndex, 7).setValue(new Date()); 
      }
    } else {
      if (rowIndex !== -1) {
        sheet.getRange(rowIndex, 3, 1, 5).setValues([[
          data.details, data.total, data.balance, "送信済", new Date()
        ]]);
      }
    }
    return ContentService.createTextOutput("Success");
  } catch (error) {
    return ContentService.createTextOutput("Error: " + error.toString());
  }
}
